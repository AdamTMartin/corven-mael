<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Corven Lore Lookup</title>
  <meta name="description" content="Searchable lore bible for Corven." />
  <meta name="robots" content="noindex,nofollow">
  <link rel="apple-touch-icon" href="assets/favicon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" href="assets/favicon.png" />
  <style>
    :root{
      --bg:#0b0e12; --panel:#121720; --muted:#a7b0c0; --text:#e7edf6; --accent:#46d3ff;
      --chip:#1b2230; --chip-border:#2a3347; --ring:0 0 0 2px rgba(70,211,255,.25); --radius:12px;
      --paper:#101521; --paper-line:#172034; --paper-edge:#0c111b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);
      background:radial-gradient(1200px 800px at 70% -10%,#101621 0%,var(--bg) 60%) no-repeat,var(--bg);line-height:1.45}
    header{max-width:1100px;margin:40px auto 10px;padding:0 20px 0 60px;position:relative}
    h1{margin:0 0 10px;letter-spacing:.3px}
    .sub{color:var(--muted)}
    .hint{color:var(--muted); font-size:14px; margin-top:4px}
    .toolbar{display:grid;gap:12px;grid-template-columns:1fr;margin:18px 0 6px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input[type=search]{width:100%;padding:14px 16px;border-radius:var(--radius);background:var(--panel);color:var(--text);
      border:1px solid #1e2634;outline:none}
    input[type=search]:focus-visible{box-shadow:var(--ring);border-color:var(--accent)}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--chip);
      border:1px solid var(--chip-border);color:var(--muted);cursor:pointer;user-select:none}
    .chip.tag-chip{background:#162035;border-color:#2b3c56;color:#cfe5ff}
    .chip.tag-chip[data-active=true]{border-color:var(--accent);color:var(--text)}
    .chip[data-active=true]{color:var(--text);border-color:var(--accent)}
    .chip.action{border-style:dashed;opacity:.9}
    /* Accent button for Graph View */
    #toggleView{background:var(--accent);color:#061018;border-color:transparent;font-weight:700;
      box-shadow:0 0 0 0 rgba(70,211,255,.25);transition:box-shadow .2s ease, transform .05s ease}
    #toggleView:hover{box-shadow:0 0 0 6px rgba(70,211,255,.25)}
    #toggleView:active{transform:translateY(1px)}
    .container{max-width:1100px;margin:12px auto 80px;padding:0 20px}
    .meta{color:var(--muted);font-size:14px}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));margin-top:16px}
    .card{background:linear-gradient(180deg,#121720 0%,#0f141d 100%);border:1px solid #1e2634;border-radius:14px;padding:16px;position:relative}
    .type{position:absolute;top:12px;right:12px;font-size:12px;color:var(--muted);border:1px solid #273149;background:#0f1521;
      padding:4px 8px;border-radius:999px;text-transform:uppercase;letter-spacing:.5px}
    .title{margin:0 0 6px;font-size:18px;letter-spacing:.2px}
    .card-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .card-actions button{background:#121a28;border:1px solid #263149;color:#dbe6f9;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:12px}
    .card-actions button:hover{border-color:var(--accent);color:#fff}
    /* List view */
    #listWrap{display:none}
    .list{list-style:none;margin:14px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
    .list-item{background:linear-gradient(180deg,#111722 0%,#0e141d 100%);border:1px solid #1f2a3b;border-radius:12px;padding:12px 14px;
      display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;cursor:pointer;transition:border-color .15s ease,box-shadow .15s ease}
    .list-item:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(70,211,255,.15)}
    .list-item .title{margin:0;font-size:16px}
    .list-item .meta{font-size:13px;color:var(--muted)}
    .list-item .summary{color:#dbe6f9;font-size:14px;margin:4px 0 0}
    .list-tags{display:flex;gap:6px;flex-wrap:wrap}
    .list-item .permalink{position:static;margin-left:6px}
    .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .tag{font-size:12px;color:#b7c2d8;border:1px dashed #2b3550;padding:4px 8px;border-radius:999px}
    .body{margin-top:10px;color:#dbe6f9}
    .body p{margin:.5em 0}
    .empty{padding:30px;border:1px dashed #2a3347;border-radius:var(--radius);color:var(--muted);text-align:center;margin-top:16px;background:#0f141d}
    .counts{margin-top:8px;color:var(--muted);font-size:14px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;background:#0e1420;border:1px solid #263149;
      padding:2px 6px;border-radius:6px;color:#bcd3ff}
    footer{max-width:1100px;margin:40px auto;padding:0 20px;color:var(--muted)}
    a{color:var(--accent);text-decoration:none}
    /* Deep-link highlight */
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(70,211,255,0)}40%{box-shadow:0 0 0 6px rgba(70,211,255,.35)}100%{box-shadow:0 0 0 0 rgba(70,211,255,0)}}
    .card.highlight{outline:2px solid var(--accent);animation:flash 1.4s ease-out 0s 1}
    /* permalink chip */
    .permalink{position:absolute;top:4px;left:10px;font-size:11px;background:#0f1521;border:1px solid #273149;border-radius:999px;
      padding:2px 7px;color:#bcd3ff;cursor:pointer;opacity:.6;transition:opacity .2s ease,transform .1s ease}
    .card:hover .permalink{opacity:1}
    .permalink:active{transform:translateY(1px)}
    /* Graph */
    #graphWrap{display:none}
    #graph{height:72vh;min-height:420px;background:#0f141d;border:1px solid #1e2634;border-radius:14px}
    .graph-controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;align-items:center;color:var(--muted);font-size:14px}
    .graph-controls select,.graph-controls input[type=search]{background:#0f1521;border:1px solid #263149;color:var(--text);border-radius:10px;padding:8px 10px}
    .graph-controls button{background:#121a28;border:1px solid #263149;color:#d5e5ff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .graph-controls button:hover{border-color:var(--accent);color:#fff}
    .dim{opacity:0.25}
    .legend{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin:8px 0 0}
    .legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .sorter{display:flex;align-items:center;gap:8px;margin-top:6px}
    .sorter select{background:#0f1521;border:1px solid #263149;color:var(--text);border-radius:10px;padding:8px 10px}
    .graph-filter{position:relative}
    .graph-filter button{min-width:90px}
    .graph-filter .panel{position:absolute;top:110%;left:0;z-index:900;background:#0e141f;border:1px solid #1f2a3b;border-radius:12px;padding:10px;width:240px;box-shadow:0 12px 30px rgba(0,0,0,0.35)}
    .graph-filter .panel h4{margin:0 0 6px;color:#dbe6f9;font-size:14px}
    .graph-filter .panel .actions{display:flex;gap:6px;margin-bottom:6px}
    .graph-filter .panel label{display:flex;align-items:center;gap:8px;color:#d5e0f5;font-size:13px;padding:4px 2px}
    /* References */
    #refsWrap{display:none}
    .refs-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));margin-top:12px}
    .ref-card{background:linear-gradient(180deg,#111722 0%,#0e141d 100%);border:1px solid #1f2a3b;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .ref-card img{width:100%;border-radius:10px;border:1px solid #1f2a3b;background:#0c111a}
    .ref-card .meta{color:#a7b0c0;font-size:13px}
    /* Reference modal */
    #refModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:1100}
    #refModal.show{display:flex}
    #refModal img{max-width:90vw;max-height:90vh;border-radius:12px;border:1px solid #1f2a3b;background:#0b0f18}
    #refModal button{position:absolute;top:16px;right:16px;background:#121a28;border:1px solid #263149;color:#dbe6f9;border-radius:10px;padding:8px 10px;cursor:pointer}

    /* Journal */
    #journalWrap{display:none}
    .journal-surface{
      background:
        linear-gradient(180deg, var(--paper-edge), var(--paper-edge)) left/6px 100% no-repeat,
        repeating-linear-gradient(#0000, #0000 32px, var(--paper-line) 33px) ,
        var(--paper);
      border:1px solid #1e2634; border-radius:14px; padding:18px; box-shadow: inset 0 1px 0 #172034;
    }
    .journal-entry{
      margin:14px 0 22px; padding:14px 16px; border:1px solid #1e2634; border-radius:12px;
      background:rgba(10,14,22,0.5);
    }
    .journal-entry.highlight{ outline:2px solid var(--accent); animation:flash 1.4s ease-out 0s 1 }
    .journal-title{ margin:0 0 6px; font-family: "Georgia", "Iowan Old Style", "Times New Roman", serif; font-size:20px; letter-spacing:.2px }
    .journal-date{ color:#b7c0d4; font-size:13px; margin-bottom:6px }
    .journal-tags{ display:flex; gap:6px; flex-wrap:wrap; margin:.25rem 0 .5rem }
    .journal-body{ font-family: "Georgia", "Iowan Old Style", "Times New Roman", serif; color:#e9f2ff; line-height:1.7 }
    .journal-body p{ margin:.6em 0 }
    .journal-group{ margin:18px 0 10px; font-weight:700; color:#d1daeb; border-left:3px solid var(--accent); padding-left:10px }

    /* Burger menu */
    .burger{ position:absolute; top:6px; left:10px; width:38px; height:34px; display:inline-flex; align-items:center; justify-content:center;
      background:#0f1521; border:1px solid #273149; border-radius:10px; cursor:pointer; }
    .burger span{ width:18px; height:2px; background:#bcd3ff; display:block; position:relative }
    .burger span::before, .burger span::after{ content:""; position:absolute; left:0; width:18px; height:2px; background:#bcd3ff }
    .burger span::before{ top:-6px } .burger span::after{ top:6px }
    .menu{ position:fixed; top:0; left:0; bottom:0; right:auto; width:260px; background:#0e141f; border-right:1px solid #1e2634; transform:translateX(-100%);
      transition:transform .2s ease; z-index:1000; padding:16px }
    .menu.open{ transform:none }
    .menu h3{ margin:6px 0 12px; color:#e7edf6 }
    .menu .menu-item{ display:block; width:100%; text-align:left; margin:6px 0; padding:10px 12px; border-radius:10px; border:1px solid #263149;
      background:#121a28; color:#cfe2ff; cursor:pointer }
    .menu .menu-item:hover{ border-color:var(--accent); color:#fff }
    .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:999 }
    .backdrop.show{ display:block }
    button:focus-visible,.chip:focus-visible,.permalink:focus-visible{
      outline:2px solid var(--accent); outline-offset:2px; box-shadow:var(--ring);
    }
  </style>
</head>
<body>
  <header>
    <button class="burger" id="burger" type="button" title="Menu" aria-label="Open navigation" aria-expanded="false" aria-controls="menu"><span></span></button>
    <h1>Corven Lore Lookup</h1>
    <div class="sub">A living, searchable lore bible for Corven\u2014people, places, events, items, and journal entries.</div>
    <div class="hint">Browse lore as cards or a compact list, jump to the graph, switch over to the campaign journal, or check shared references like maps.</div>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Search by title, tags, content (try: 'Apostate Crow', 'Mojon', 'mentor')" aria-label="Search lore and journal" />
      <div class="row">
        <div class="filters" id="typeFilters"></div>
        <div class="filters" id="tagFilters"></div>
      </div>
    </div>
    <div class="counts" id="counts"></div>
    <div class="sorter">
      <label for="sortMode" class="meta">Sort</label>
      <select id="sortMode" aria-label="Sort entries">
        <option value="date_desc" selected>Date (newest)</option>
        <option value="date_asc">Date (oldest)</option>
        <option value="title_asc">Title (A–Z)</option>
        <option value="title_desc">Title (Z–A)</option>
      </select>
    </div>
    <div class="row meta" id="viewPrompts">
      <button id="journalPrompt" class="chip action" type="button" title="Jump to the journal view">Open Journal</button>
      <button id="cardsPrompt" class="chip action" type="button" title="Back to lore cards" style="display:none;">Cards View</button>
      <button id="toggleView" class="chip" type="button" title="Switch between Cards and Graph" aria-label="Switch between cards and graph" aria-pressed="false">Graph View</button>
      <button id="listView" class="chip" type="button" title="Switch between Cards and List" aria-label="Switch between cards and list" aria-pressed="false">List View</button>
    </div>
  </header>

  <div class="container">
    <!-- Cards -->
    <div id="cardsWrap">
      <div id="results" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">No matching entries. Try fewer filters or a different search.</div>
    </div>

    <!-- List -->
    <div id="listWrap">
      <ul id="listResults" class="list"></ul>
      <div id="listEmpty" class="empty" style="display:none;">No matching entries. Try fewer filters or a different search.</div>
    </div>

    <!-- References -->
    <div id="refsWrap">
      <div class="refs-grid" id="refsGrid"></div>
      <div id="refsEmpty" class="empty" style="display:none;">No reference items yet.</div>
    </div>

    <!-- Graph -->
    <div id="graphWrap">
      <div id="graph"></div>
      <div class="graph-controls">
        <label for="graphLayout" class="meta">Layout</label>
        <select id="graphLayout" aria-label="Select graph layout">
          <option value="cose" selected>Cose</option>
          <option value="concentric">Concentric</option>
          <option value="circle">Circle</option>
          <option value="breadthfirst">Breadthfirst</option>
        </select>
        <button id="graphReset" type="button" title="Reset view">Reset</button>
        <button id="graphNeighbors" type="button" aria-pressed="false" title="Highlight neighbors">Highlight neighbors</button>
        <button id="graphExport" type="button" title="Download PNG">Export PNG</button>
        <input id="graphSearch" type="search" placeholder="Find node (title or slug)" aria-label="Find node in graph" />
        <button id="graphSearchBtn" type="button" title="Find node">Go</button>
        <div class="graph-filter">
          <button id="graphTypeToggle" type="button" aria-expanded="false">Filter types</button>
          <div id="graphTypePanel" class="panel" style="display:none;">
            <h4>Show types</h4>
            <div class="actions">
              <button type="button" id="graphTypeAll">Select all</button>
              <button type="button" id="graphTypeNone">Deselect all</button>
            </div>
            <div id="graphTypeList"></div>
          </div>
        </div>
      </div>
      <div id="graphHelp" class="meta" style="margin-top:6px;">
        Tip: click a node to open the entry; <span class="kbd">Shift</span> + click opens it in a new tab. Layout adapts to the current filters and search.
      </div>
      <div class="legend" id="legend"></div>
    </div>

    <!-- Journal -->
    <div id="journalWrap">
      <div class="journal-surface" id="journalSurface"></div>
      <div id="journalEmpty" class="empty" style="display:none;">No matching entries in the journal.</div>
    </div>
  </div>

  <!-- Slide-out menu -->
  <div class="menu" id="menu" role="navigation" aria-label="View selector">
    <h3>Navigate</h3>
    <button class="menu-item" type="button" data-target="cards">Lore (Cards)</button>
    <button class="menu-item" type="button" data-target="refs">References</button>
    <button class="menu-item" type="button" data-target="list">Lore (List)</button>
    <button class="menu-item" type="button" data-target="graph">Lore (Graph)</button>
    <button class="menu-item" type="button" data-target="journal">Journal</button>
  </div>
  <div class="backdrop" id="backdrop"></div>
  <div id="refModal" role="dialog" aria-modal="true" aria-label="Reference image">
    <img id="refModalImg" alt="">
    <button type="button" id="refModalClose">Close</button>
  </div>

  <footer>
    Tip: open a lore entry in a new tab with <span class="kbd">Alt</span> + click. Edit lore in <code>/data/data.js</code> and journal in <code>/data/journal.js</code>.
  </footer>

  <!-- Vendors (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Data -->
  <script src="data/data.js"></script>
  <script src="data/journal.js"></script>

  <!-- App -->
  <script>
    // --- Deep-link helpers ---
    function currentSlugFromURL(){
      const h=(location.hash||"").replace(/^#/,"").trim();
      if(h.startsWith("journal/")) return { journal:h.slice(8) };
      if(h) return { slug:h };
      const p=new URLSearchParams(location.search);
      const view=(p.get("view")||"").trim();
      const slug=(p.get("slug")||"").trim();
      return { slug: slug || "", view: view || "" };
    }
    function setSlugInURL(slug){
      const url=new URL(window.location.href); url.hash=slug; url.searchParams.set("slug",slug);
      history.replaceState(null,"",url);
    }
    function setJournalURL(slug){
      const url=new URL(window.location.href); url.hash=`journal/${slug}`; url.searchParams.set("view","journal");
      history.replaceState(null,"",url);
    }
    let highlightTimer=null;
    function focusBySlug(slug,flash=true){
      if(!slug) return; const el=document.getElementById(slug); if(!el) return;
      if(viewState.mode!=='cards') toggleTo('cards',false);
      el.scrollIntoView({behavior:"smooth",block:"start"});
      if(flash){ el.classList.add("highlight"); clearTimeout(highlightTimer);
        highlightTimer=setTimeout(()=>el.classList.remove("highlight"),2000); }
    }
    function focusJournalBySlug(slug,flash=true){
      const el=document.getElementById('journal-'+slug); if(!el) return;
      if(viewState.mode!=='journal') toggleTo('journal',false);
      el.scrollIntoView({behavior:"smooth",block:"start"});
      if(flash){ el.classList.add("highlight"); setTimeout(()=>el.classList.remove("highlight"),2000); }
    }
    async function copyPermalink(slug){
      const url=new URL(window.location.href); url.hash=slug; url.searchParams.set("slug",slug);
      await navigator.clipboard.writeText(url.toString());
    }
    async function copyJournalPermalink(slug){
      const url=new URL(window.location.href); url.hash=`journal/${slug}`; url.searchParams.set("view","journal");
      await navigator.clipboard.writeText(url.toString());
    }
    async function copyCard(slug){
      const entry=state.data.find(e=>e.slug===slug); if(!entry) return;
      const tags=(entry.tags||[]).map(t=>`#${t}`).join(' ');
      const lines=[
        `# ${entry.title || '(untitled)'}`,
        `${entry.type || ''}${entry.date ? ' · '+entry.date : ''}`.trim(),
        entry.summary || '',
        tags,
        '',
        entry.body || ''
      ].filter(Boolean);
      const text=lines.join('\n');
      try{
        await navigator.clipboard.writeText(text);
      }catch(err){
        console.error(err);
      }
    }
    async function saveCardPng(slug){
      const el=document.getElementById(slug); if(!el || !window.html2canvas) return;
      const clone=el.cloneNode(true);
      clone.style.position='absolute'; clone.style.top='-9999px'; clone.style.left='-9999px'; clone.style.width=el.offsetWidth+'px';
      document.body.appendChild(clone);
      try{
        const canvas=await html2canvas(clone,{backgroundColor:'#0b0e12',scale:2});
        const data=canvas.toDataURL('image/png');
        const a=document.createElement('a'); a.href=data; a.download=`${slug}.png`; a.click();
      }catch(err){ console.error(err); }
      finally{ document.body.removeChild(clone); }
    }

    // --- Config ---
    const TYPES=["Person","Player","Place","Event","Item","Faction","Concept","Note"];
    const TAG_LIMIT=8;

    const TYPE_COLOR={ Person:"#6bd4ff", Place:"#ffa942", Event:"#a8ff6b", Item:"#b18cff", Faction:"#ff6b9b", Concept:"#8ad6a6", Note:"#b7c0d4" };

    // --- State ---
    const REFERENCES=[
      {
        title:"Caves of Chaos",
        desc:"Shared by the DM for quick reference.",
        src:"assets/map.jpg",
        alt:"Caves of Chaos map",
        note:"Place your map image at assets/map.jpg to display it here."
      }
    ];

    let state={
      q:"", activeTypes:new Set(), activeTags:new Set(),
      data:(window.CORVEN_DATA||[]),
      journal:(window.JOURNAL_DATA||[]),
      fuse:null, jfuse:null,
      showAllTags:false, showAllJournalTags:false,
      sortMode:'date_desc'
    };
    let viewState={ mode:'cards', cy:null, layout:'cose', highlightNeighbors:false, graphTypeFilter:null };

    // Build search indexes
    function buildIndex(){
      state.fuse=new Fuse(state.data,{ keys:[{name:'title',weight:.5},{name:'summary',weight:.3},{name:'tags',weight:.2},{name:'body',weight:.4}],
        includeScore:true, threshold:.36, ignoreLocation:true, minMatchCharLength:2 });
      state.jfuse=new Fuse(state.journal,{ keys:[{name:'title',weight:.5},{name:'tags',weight:.2},{name:'body',weight:.5}],
        includeScore:true, threshold:.34, ignoreLocation:true, minMatchCharLength:2 });
    }

    // Tag helpers
    function allLoreTags(){
      const c={}; state.data.forEach(e=>(e.tags||[]).forEach(t=>c[t]=(c[t]||0)+1));
      return Object.entries(c).sort((a,b)=>b[1]-a[1]).map(([tag,count])=>({tag,count}));
    }
    function allJournalTags(){
      const c={}; state.journal.forEach(e=>(e.tags||[]).forEach(t=>c[t]=(c[t]||0)+1));
      return Object.entries(c).sort((a,b)=>b[1]-a[1]).map(([tag,count])=>({tag,count}));
    }

    // Filters UI (adapts per view)
    function renderFilters(){
      const typeWrap=document.getElementById('typeFilters');
      const tagWrap=document.getElementById('tagFilters');
      typeWrap.innerHTML=''; tagWrap.innerHTML='';
      if(viewState.mode==='journal'){
        // No types in journal; only tags
        const all=allJournalTags();
        const visible = state.showAllJournalTags ? all : all.slice(0, TAG_LIMIT);
        visible.forEach(({tag})=>{
          const chip=document.createElement('button'); chip.className='chip tag-chip'; chip.type='button'; chip.textContent=`#${tag}`;
          chip.setAttribute('data-active', state.activeTags.has(tag)?'true':'false');
          chip.setAttribute('aria-pressed', state.activeTags.has(tag)?'true':'false');
          chip.setAttribute('aria-label', `Filter journal by tag ${tag}`);
          chip.addEventListener('click',()=>{ state.activeTags.has(tag)?state.activeTags.delete(tag):state.activeTags.add(tag); render(); });
          tagWrap.appendChild(chip);
        });
        if(all.length > TAG_LIMIT){
          const more=document.createElement('button'); more.className='chip action'; more.type='button';
          more.textContent = state.showAllJournalTags ? 'Show less tags' : `Show more tags (+${all.length - TAG_LIMIT})`;
          more.addEventListener('click',()=>{ state.showAllJournalTags=!state.showAllJournalTags; renderFilters(); });
          tagWrap.appendChild(more);
        }
      } else {
        // Cards / Graph
        TYPES.forEach(t=>{
          const chip=document.createElement('button'); chip.className='chip'; chip.type='button'; chip.textContent=t;
          chip.setAttribute('data-active', state.activeTypes.has(t)?'true':'false');
          chip.setAttribute('aria-pressed', state.activeTypes.has(t)?'true':'false');
          chip.setAttribute('aria-label', `Filter lore by type ${t}`);
          chip.addEventListener('click',()=>{ state.activeTypes.has(t)?state.activeTypes.delete(t):state.activeTypes.add(t); render(); });
          typeWrap.appendChild(chip);
        });
        const all=allLoreTags();
        const visible = state.showAllTags ? all : all.slice(0, TAG_LIMIT);
        visible.forEach(({tag})=>{
          const chip=document.createElement('button'); chip.className='chip tag-chip'; chip.type='button'; chip.textContent=`#${tag}`;
          chip.setAttribute('data-active', state.activeTags.has(tag)?'true':'false');
          chip.setAttribute('aria-pressed', state.activeTags.has(tag)?'true':'false');
          chip.setAttribute('aria-label', `Filter lore by tag ${tag}`);
          chip.addEventListener('click',()=>{ state.activeTags.has(tag)?state.activeTags.delete(tag):state.activeTags.add(tag); render(); });
          tagWrap.appendChild(chip);
        });
        if(all.length > TAG_LIMIT){
          const more=document.createElement('button'); more.className='chip action'; more.type='button';
          more.textContent = state.showAllTags ? 'Show less tags' : `Show more tags (+${all.length - TAG_LIMIT})`;
          more.addEventListener('click',()=>{ state.showAllTags=!state.showAllTags; renderFilters(); });
          tagWrap.appendChild(more);
        }
      }
    }

    // Query lore
    function sortLore(rows){
      const mode=(state.sortMode||'date_desc');
      return rows.sort((a,b)=>{
        const da=a.date?Date.parse(a.date):0, db=b.date?Date.parse(b.date):0;
        if(mode==='date_desc') return db-da;
        if(mode==='date_asc') return da-db;
        const ta=(a.title||"").toLowerCase(), tb=(b.title||"").toLowerCase();
        if(mode==='title_asc') return ta.localeCompare(tb);
        if(mode==='title_desc') return tb.localeCompare(ta);
        return db-da;
      });
    }

    function queryLore(){
      let rows=state.data.slice();
      if(state.q && state.q.trim().length>0){ rows=state.fuse.search(state.q.trim()).map(r=>r.item); }
      if(state.activeTypes.size>0){ rows=rows.filter(r=>state.activeTypes.has(r.type)); }
      if(state.activeTags.size>0){ rows=rows.filter(r=>(r.tags||[]).some(t=>state.activeTags.has(t))); }
      return sortLore(rows);
    }

    // Query journal
    function queryJournal(){
      let rows=state.journal.slice();
      if(state.q && state.q.trim().length>0){ rows=state.jfuse.search(state.q.trim()).map(r=>r.item); }
      if(state.activeTags.size>0){ rows=rows.filter(r=>(r.tags||[]).some(t=>state.activeTags.has(t))); }
      const mode=(state.sortMode||'date_desc');
      rows.sort((a,b)=>{
        const da=a.date?Date.parse(a.date):0; const db=b.date?Date.parse(b.date):0;
        if(mode==='date_desc') return db-da;
        if(mode==='date_asc') return da-db;
        const ta=(a.title||"").toLowerCase(), tb=(b.title||"").toLowerCase();
        if(mode==='title_asc') return ta.localeCompare(tb);
        if(mode==='title_desc') return tb.localeCompare(ta);
        return db-da;
      });
      return rows;
    }

    // Cross-link helper for lore bodies
    function linkBody(html,all){
      return html.replace(/\[\[([a-z0-9\-]+)\]\]/gi,(m,slug)=>{
        const target=all.find(e=>e.slug===slug);
        return target ? `<a href="#${target.slug}" data-slug="${target.slug}" class="xref">${target.title}</a>` : m;
      });
    }
    // Cross-link helper for journal bodies (to lore)
    function linkJournalBody(html,allLore){
      return html.replace(/\[\[([a-z0-9\-]+)\]\]/gi,(m,slug)=>{
        const target=allLore.find(e=>e.slug===slug);
        return target ? `<a href="#${target.slug}" data-slug="${target.slug}" class="xref-lore">${target.title}</a>` : m;
      });
    }

    // --- Cards view ---
    function renderCards(rows){
      const res=document.getElementById('results'), empty=document.getElementById('empty'), counts=document.getElementById('counts');
      counts.textContent=`${rows.length} result${rows.length===1?'':'s'} / ${state.data.length} total lore entries`;
      if(rows.length===0){ res.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none';

      res.innerHTML=rows.map(e=>{
        const tags=(e.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join('');
        const date=e.date?`<span class="meta">${new Date(e.date).toLocaleDateString()}</span>`:'';
        const bodyHTML=linkBody(marked.parse(e.body||''),state.data);
        return `
          <article class="card" id="${e.slug}">
            <button class="permalink" data-slug="${e.slug}" title="Copy link" aria-label="Copy link to ${e.title}">Link</button>
            <div class="type">${e.type}</div>
            <h3 class="title">${e.title}</h3>
            <div class="meta">${date}${e.summary ? (date?' / ':'') + e.summary : ''}</div>
            <div class="tags">${tags}</div>
            <div class="body">${bodyHTML}</div>
            <div class="card-actions">
              <button type="button" data-card-copy="${e.slug}">Copy card</button>
              <button type="button" data-card-png="${e.slug}">Save PNG</button>
            </div>
          </article>
        `;
      }).join('');

      res.querySelectorAll('.permalink').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const slug=btn.getAttribute('data-slug'); setSlugInURL(slug); await copyPermalink(slug);
          btn.textContent="Copied!"; setTimeout(()=>btn.textContent="Link",900);
        });
      });
      res.querySelectorAll('a.xref').forEach(a=>{
        a.addEventListener('click',(e)=>{
          const slug=a.getAttribute('data-slug');
          if(e.altKey){ const url=new URL(window.location.href); url.hash=slug; url.searchParams.set("slug",slug); window.open(url.toString(),'_blank'); }
          else{ e.preventDefault(); setSlugInURL(slug); focusBySlug(slug,true); }
        });
      });
      res.querySelectorAll('[data-card-copy]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ copyCard(btn.getAttribute('data-card-copy')); });
      });
      res.querySelectorAll('[data-card-png]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ saveCardPng(btn.getAttribute('data-card-png')); });
      });
    }

    // --- List view ---
    function renderList(rows){
      const wrap=document.getElementById('listWrap');
      const list=document.getElementById('listResults');
      const empty=document.getElementById('listEmpty');
      const counts=document.getElementById('counts');
      counts.textContent=`${rows.length} result${rows.length===1?'':'s'} / ${state.data.length} total lore entries`;

      if(rows.length===0){ list.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none';

      list.innerHTML = rows.map(e=>{
        const tags=(e.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join('');
        const date=e.date?`<span class="meta">${new Date(e.date).toLocaleDateString()}</span>`:'';
        const summary=e.summary || '';
        return `
          <li class="list-item" data-slug="${e.slug}" tabindex="0">
            <div>
              <div class="meta">${e.type}${date ? ' · ' + date : ''}</div>
              <h3 class="title">${e.title}</h3>
              <div class="summary">${summary}</div>
              <div class="list-tags">${tags}</div>
            </div>
            <div style="display:flex;align-items:center;">
              <button class="permalink" data-slug="${e.slug}" title="Copy link" aria-label="Copy link to ${e.title}" type="button">Link</button>
            </div>
          </li>
        `;
      }).join('');

      list.querySelectorAll('.permalink').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          const slug=btn.getAttribute('data-slug'); setSlugInURL(slug); await copyPermalink(slug);
          btn.textContent="Copied!"; setTimeout(()=>btn.textContent="Link",900);
        });
      });

      list.querySelectorAll('.list-item').forEach(li=>{
        const slug=li.getAttribute('data-slug');
        const openCard=()=>{ setSlugInURL(slug); toggleTo('cards', false); focusBySlug(slug,true); };
        li.addEventListener('click', openCard);
        li.addEventListener('keypress',(e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openCard(); } });
      });
    }

    // --- References view ---
    function renderRefs(){
      const grid=document.getElementById('refsGrid');
      const empty=document.getElementById('refsEmpty');
      if(!REFERENCES.length){ grid.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none';
      grid.innerHTML = REFERENCES.map(ref=>{
        const img = ref.src ? `<img src="${ref.src}" alt="${ref.alt||ref.title}" data-ref-src="${ref.src}" data-ref-title="${ref.title}" onerror="this.style.display='none'; const fallback=this.nextElementSibling; if(fallback) fallback.style.display='block';" />` : '';
        const fallback = ref.note ? `<div class="meta" style="display:none;">${ref.note}</div>` : '';
        return `
          <article class="ref-card">
            <div class="meta">${ref.desc || ''}</div>
            <h3 class="title">${ref.title}</h3>
            ${img}${fallback}
          </article>
        `;
      }).join('');

      grid.querySelectorAll('img[data-ref-src]').forEach(img=>{
        img.style.cursor='pointer';
        img.addEventListener('click', ()=>{
          openRefModal(img.getAttribute('data-ref-src'), img.getAttribute('data-ref-title') || img.alt || 'Reference');
        });
      });
    }

    // --- Graph view ---
    function buildGraphElements(rows){
      const nodes=new Map(), edges=new Map(), bySlug=new Map(rows.map(r=>[r.slug,r]));
      rows.forEach(r=>{ nodes.set(r.slug,{ data:{ id:r.slug, label:r.title, type:r.type } }); });
      const REF_RE=/\[\[([a-z0-9\-]+)\]\]/gi;
      rows.forEach(r=>{
        const body=r.body||""; let m;
        while((m=REF_RE.exec(body))!==null){
          const target=m[1]; if(bySlug.has(target)){ const key=r.slug+'->'+target; if(!edges.has(key)) edges.set(key,{ data:{ id:key, source:r.slug, target } }); }
        }
      });
      return [...nodes.values(), ...edges.values()];
    }
    function graphTypes(){
      const set=new Set();
      state.data.forEach(e=>{ if(e.type) set.add(e.type); });
      return [...set].sort();
    }

    function applyGraphTypeFilter(rows){
      if(viewState.graphTypeFilter===null) return rows; // null means "all types"
      if(viewState.graphTypeFilter.size===0) return []; // empty set means "show none"
      return rows.filter(r=>viewState.graphTypeFilter.has(r.type));
    }

    function renderGraph(rows){
      const wrap=document.getElementById('graph');
      if(viewState.cy){ viewState.cy.destroy(); viewState.cy=null; }
      const filteredRows=applyGraphTypeFilter(rows);
      const elements=buildGraphElements(filteredRows);
      const layoutName=viewState.layout || 'cose';
      viewState.cy=cytoscape({
        container:wrap, elements,
        style:[
          { selector:'node', style:{
            'background-color': ele=>TYPE_COLOR[ele.data('type')]||'#9aa7bd',
            'label':'data(label)', 'color':'#e7edf6','font-size':10,'text-wrap':'wrap','text-max-width':140,
            'text-outline-color':'#0f141d','text-outline-width':2,'border-width':1,'border-color':'#263149','width':16,'height':16 } },
          { selector:'edge', style:{ 'line-color':'#35507a','target-arrow-color':'#35507a','target-arrow-shape':'triangle','curve-style':'bezier','width':1.5 } },
          { selector:'node:selected', style:{ 'border-width':3,'border-color':'#46d3ff' } }
        ],
        layout:{ name:layoutName, animate:true, padding:30, nodeOverlap:8 }
      });
      viewState.cy.on('tap','node',(evt)=>{
        const slug=evt.target.data('id');
        if(evt.originalEvent && evt.originalEvent.shiftKey){
          const url=new URL(window.location.href); url.hash=slug; url.searchParams.set('slug',slug); window.open(url.toString(),'_blank'); return;
        }
        applyNeighborHighlight(evt.target);
        setSlugInURL(slug); focusBySlug(slug,true);
      });
      viewState.cy.on('tap',(evt)=>{ if(evt.target===viewState.cy){ applyNeighborHighlight(null); } });
      const legend=document.getElementById('legend');
      legend.innerHTML=Object.entries(TYPE_COLOR).map(([type,color])=>`<span><span class="dot" style="background:${color}"></span>${type}</span>`).join('');

      // Sync UI controls to current layout/highlight state
      const layoutSelect=document.getElementById('graphLayout');
      if(layoutSelect){ layoutSelect.value=layoutName; }
      const neighborBtn=document.getElementById('graphNeighbors');
      if(neighborBtn){ neighborBtn.setAttribute('aria-pressed', viewState.highlightNeighbors?'true':'false'); neighborBtn.textContent = viewState.highlightNeighbors ? 'Neighbors: on' : 'Highlight neighbors'; }
      applyNeighborHighlight(null);
    }

    function applyNeighborHighlight(node){
      if(!viewState.cy) return;
      viewState.cy.elements().removeClass('dim');
      if(!viewState.highlightNeighbors) return;
      if(!node){ return; }
      const hood=node.closedNeighborhood();
      viewState.cy.elements().difference(hood).addClass('dim');
    }

    function runGraphLayout(name){
      if(!viewState.cy) return;
      viewState.layout=name;
      const opts={ name, padding:30, animate:true, fit:true, nodeOverlap:8 };
      if(name==='breadthfirst') opts.directed=true;
      viewState.cy.layout(opts).run();
    }

    function resetGraphView(){
      if(!viewState.cy) return;
      viewState.cy.elements().removeClass('dim');
      viewState.highlightNeighbors=false;
      const neighborBtn=document.getElementById('graphNeighbors');
      if(neighborBtn){ neighborBtn.setAttribute('aria-pressed','false'); neighborBtn.textContent='Highlight neighbors'; }
      runGraphLayout(viewState.layout || 'cose');
    }

    function graphSearch(query){
      if(!viewState.cy) return;
      const q=(query||'').trim().toLowerCase();
      if(!q) return;
      const node=viewState.cy.nodes().toArray().find(n=>{
        const id=(n.data('id')||'').toLowerCase();
        const label=(n.data('label')||'').toLowerCase();
        return id===q || label.includes(q);
      });
      if(node){
        viewState.cy.elements().unselect();
        node.select();
        viewState.cy.fit(node, 80);
        applyNeighborHighlight(node);
        setSlugInURL(node.data('id'));
      }
    }

    function openRefModal(src,title){
      const modal=document.getElementById('refModal');
      const img=document.getElementById('refModalImg');
      img.src=src;
      img.alt=title || 'Reference image';
      modal.classList.add('show');
      document.body.style.overflow='hidden';
      modal.focus();
    }
    function closeRefModal(){
      const modal=document.getElementById('refModal');
      modal.classList.remove('show');
      document.body.style.overflow='';
    }

    // --- Journal view ---
    function renderJournal(rows){
      const surface=document.getElementById('journalSurface');
      const empty=document.getElementById('journalEmpty');
      const counts=document.getElementById('counts');

      counts.textContent = `${rows.length} journal entr${rows.length===1?'y':'ies'} / ${state.journal.length} total`;

      if(rows.length===0){ surface.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none';

      // Group by date (YYYY-MM-DD), show "Undated" if missing
      const groups=new Map();
      rows.forEach(r=>{
        const key=r.date || 'Undated';
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(r);
      });
      // Sort groups by date desc, 'Undated' last
      const keys=[...groups.keys()].sort((a,b)=>{
        if(a==='Undated') return 1; if(b==='Undated') return -1;
        return Date.parse(b)-Date.parse(a);
      });

      surface.innerHTML = keys.map(k=>{
        const pretty = k==='Undated' ? 'Undated' : new Date(k).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
        const items = groups.get(k).sort((a,b)=>(a.title||'').localeCompare(b.title||''));
        const blocks = items.map(e=>{
          const tags=(e.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join('');
          const bodyHTML=linkJournalBody(marked.parse(e.body||''), state.data);
          return `
            <section class="journal-entry" id="journal-${e.slug}">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
                <h3 class="journal-title">${e.title || '(untitled)'}</h3>
                <button class="chip" data-jpermalink="${e.slug}" title="Copy link" aria-label="Copy link to journal entry ${e.title}" type="button">Link</button>
              </div>
              <div class="journal-date">${pretty}${e.date && k==='Undated' ? '' : ''}</div>
              <div class="journal-tags">${tags}</div>
              <div class="journal-body">${bodyHTML}</div>
            </section>
          `;
        }).join('');
        return `<div class="journal-group">${pretty}</div>${blocks}`;
      }).join('');

      // Wire journal permalinks
      surface.querySelectorAll('[data-jpermalink]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const slug=btn.getAttribute('data-jpermalink'); setJournalURL(slug); await copyJournalPermalink(slug);
          btn.textContent="Copied!"; setTimeout(()=>btn.textContent="Link",900);
        });
      });

      // Wire journal -> lore xrefs
      surface.querySelectorAll('a.xref-lore').forEach(a=>{
        a.addEventListener('click',(e)=>{
          e.preventDefault();
          const slug=a.getAttribute('data-slug');
          setSlugInURL(slug);
          focusBySlug(slug,true);
        });
      });
    }

    // --- View toggle ---
    function toggleTo(mode,rerender=true){
      viewState.mode=mode;
      const btn=document.getElementById('toggleView'),
            listBtn=document.getElementById('listView'),
            cardsWrap=document.getElementById('cardsWrap'),
            graphWrap=document.getElementById('graphWrap'),
            listWrap=document.getElementById('listWrap'),
            refsWrap=document.getElementById('refsWrap'),
            journalWrap=document.getElementById('journalWrap'),
            journalPrompt=document.getElementById('journalPrompt'),
            cardsPrompt=document.getElementById('cardsPrompt');

      // show/hide sections
      cardsWrap.style.display = (mode==='cards') ? 'block' : 'none';
      graphWrap.style.display = (mode==='graph') ? 'block' : 'none';
      refsWrap.style.display = (mode==='refs') ? 'block' : 'none';
      listWrap.style.display = (mode==='list') ? 'block' : 'none';
      journalWrap.style.display = (mode==='journal') ? 'block' : 'none';

      // button label
      btn.textContent = (mode==='graph') ? 'Cards View' : 'Graph View';
      btn.setAttribute('aria-pressed', mode==='graph' ? 'true' : 'false');
      btn.setAttribute('aria-label', mode==='graph' ? 'Switch to cards view' : 'Switch to graph view');
      if(listBtn){
        listBtn.textContent = (mode==='list') ? 'Cards View' : 'List View';
        listBtn.setAttribute('aria-pressed', mode==='list' ? 'true' : 'false');
        listBtn.setAttribute('aria-label', mode==='list' ? 'Switch to cards view' : 'Switch to list view');
      }

      if(journalPrompt){ journalPrompt.style.display = mode==='journal' ? 'none' : 'inline-flex'; }
      if(cardsPrompt){ cardsPrompt.style.display = mode==='journal' ? 'inline-flex' : 'none'; }

      // reset type/tag filters when switching modes to avoid confusion
      if(mode==='journal'){ state.activeTypes.clear(); state.activeTags.clear(); state.showAllTags=false; }
      else{ state.activeTags.clear(); state.showAllJournalTags=false; }

      renderFilters();
      if(rerender) render();
    }

    // Unified render
    function render(){
      if(viewState.mode==='graph'){
        const rows=queryLore();
        const filtered=applyGraphTypeFilter(rows);
        document.getElementById('counts').textContent=`${filtered.length} node${filtered.length===1?'':'s'} in graph / ${rows.length} filtered lore / ${state.data.length} total lore entries`;
        renderGraph(rows);
      } else if(viewState.mode==='list'){
        const rows=queryLore();
        renderList(rows);
      } else if(viewState.mode==='refs'){
        document.getElementById('counts').textContent=`Reference materials`;
        renderRefs();
      } else if(viewState.mode==='journal'){
        const rows=queryJournal();
        renderJournal(rows);
      } else {
        renderCards(queryLore());
      }
    }

    // Events
    document.getElementById('q').addEventListener('input', e=>{ state.q=e.target.value; render(); });
    document.getElementById('toggleView').addEventListener('click', ()=>{ toggleTo(viewState.mode==='graph'?'cards':'graph'); render(); });
    document.getElementById('listView').addEventListener('click', ()=>{ toggleTo(viewState.mode==='list'?'cards':'list'); render(); });
    const sortSelect=document.getElementById('sortMode');
    if(sortSelect){ sortSelect.addEventListener('change',(e)=>{ state.sortMode=e.target.value; render(); }); }
    const journalPromptBtn=document.getElementById('journalPrompt');
    const cardsPromptBtn=document.getElementById('cardsPrompt');
    if(journalPromptBtn){ journalPromptBtn.addEventListener('click', ()=>{ toggleTo('journal'); render(); }); }
    if(cardsPromptBtn){ cardsPromptBtn.addEventListener('click', ()=>{ toggleTo('cards'); render(); }); }
    const graphLayoutSelect=document.getElementById('graphLayout');
    if(graphLayoutSelect){ graphLayoutSelect.addEventListener('change', (e)=>{ runGraphLayout(e.target.value); applyNeighborHighlight(null); }); }
    const graphReset=document.getElementById('graphReset');
    if(graphReset){ graphReset.addEventListener('click', resetGraphView); }
    const graphNeighborsBtn=document.getElementById('graphNeighbors');
    if(graphNeighborsBtn){
      graphNeighborsBtn.addEventListener('click', ()=>{
        viewState.highlightNeighbors=!viewState.highlightNeighbors;
        graphNeighborsBtn.setAttribute('aria-pressed', viewState.highlightNeighbors?'true':'false');
        graphNeighborsBtn.textContent = viewState.highlightNeighbors ? 'Neighbors: on' : 'Highlight neighbors';
        applyNeighborHighlight(null);
      });
    }
    const graphExportBtn=document.getElementById('graphExport');
    if(graphExportBtn){
      graphExportBtn.addEventListener('click', ()=>{
        if(!viewState.cy) return;
        const png=viewState.cy.png({ full:true, scale:2, bg:'#0f141d' });
        const a=document.createElement('a'); a.href=png; a.download='corven-graph.png'; a.click();
      });
    }
    const graphSearchInput=document.getElementById('graphSearch');
    const graphSearchBtn=document.getElementById('graphSearchBtn');
    if(graphSearchBtn){ graphSearchBtn.addEventListener('click', ()=>{ graphSearch(graphSearchInput.value); }); }
    if(graphSearchInput){ graphSearchInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ graphSearch(graphSearchInput.value); } }); }
    const refModal=document.getElementById('refModal');
    const refModalClose=document.getElementById('refModalClose');
    if(refModalClose){ refModalClose.addEventListener('click', closeRefModal); }
    if(refModal){ refModal.addEventListener('click',(e)=>{ if(e.target===refModal){ closeRefModal(); } }); }
    const graphTypeToggle=document.getElementById('graphTypeToggle');
    const graphTypePanel=document.getElementById('graphTypePanel');
    const graphTypeList=document.getElementById('graphTypeList');
    const graphTypeAll=document.getElementById('graphTypeAll');
    const graphTypeNone=document.getElementById('graphTypeNone');
    function syncGraphTypeUI(){
      if(!graphTypeList) return;
      const types=graphTypes();
      graphTypeList.innerHTML=types.map(t=>{
        const checked = (viewState.graphTypeFilter===null) || viewState.graphTypeFilter.has(t);
        return `<label><input type="checkbox" data-graph-type="${t}" ${checked?'checked':''}/> ${t}</label>`;
      }).join('');
      graphTypeList.querySelectorAll('input[data-graph-type]').forEach(cb=>{
        cb.addEventListener('change', ()=>{
          const t=cb.getAttribute('data-graph-type');
          if(viewState.graphTypeFilter===null) viewState.graphTypeFilter=new Set(types);
          if(cb.checked){ viewState.graphTypeFilter.add(t); } else { viewState.graphTypeFilter.delete(t); }
          // If all are selected, set to null to mean "all"
          if(viewState.graphTypeFilter.size===types.length) viewState.graphTypeFilter=null;
          render();
        });
      });
    }
    if(graphTypeToggle && graphTypePanel){
      graphTypeToggle.addEventListener('click', ()=>{
        const open=graphTypePanel.style.display==='block';
        graphTypePanel.style.display = open ? 'none' : 'block';
        graphTypeToggle.setAttribute('aria-expanded', open ? 'false' : 'true');
        if(!open) syncGraphTypeUI();
      });
      document.addEventListener('click',(e)=>{
        if(!graphTypePanel.contains(e.target) && e.target!==graphTypeToggle){
          graphTypePanel.style.display='none';
          graphTypeToggle.setAttribute('aria-expanded','false');
        }
      });
    }
    if(graphTypeAll){
      graphTypeAll.addEventListener('click', ()=>{
        viewState.graphTypeFilter = null; // null = all
        syncGraphTypeUI();
        render();
      });
    }
    if(graphTypeNone){
      graphTypeNone.addEventListener('click', ()=>{
        viewState.graphTypeFilter = new Set(); // empty = none
        syncGraphTypeUI();
        render();
      });
    }
    window.addEventListener('resize', ()=>{ if(viewState.mode==='graph' && viewState.cy){ viewState.cy.resize(); viewState.cy.fit(undefined,30); } });

    // Burger menu logic
    const burger=document.getElementById('burger');
    const menu=document.getElementById('menu');
    const backdrop=document.getElementById('backdrop');
    menu.setAttribute('aria-hidden','true');
    function openMenu(){ menu.classList.add('open'); backdrop.classList.add('show'); burger.setAttribute('aria-expanded','true'); menu.setAttribute('aria-hidden','false'); }
    function closeMenu(){ menu.classList.remove('open'); backdrop.classList.remove('show'); burger.setAttribute('aria-expanded','false'); menu.setAttribute('aria-hidden','true'); }
    burger.addEventListener('click', openMenu);
    backdrop.addEventListener('click', closeMenu);
    menu.querySelectorAll('.menu-item').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target=btn.getAttribute('data-target');
        closeMenu();
        toggleTo(target,true);
      });
    });

    // Boot
    buildIndex();
    // Respect ?view on initial load
    const init = currentSlugFromURL();
    const qs = new URLSearchParams(location.search);
    const want = (qs.get('view')||'').toLowerCase();
    if(want==='journal'){ toggleTo('journal', false); }
    else if(want==='graph'){ toggleTo('graph', false); }
    else if(want==='list'){ toggleTo('list', false); }
    else if(want==='refs'){ toggleTo('refs', false); }
    else { toggleTo('cards', false); }
    renderFilters();
    render();

    // Focus if URL has deep link
    if(init.journal){ focusJournalBySlug(init.journal, true); }
    else if(init.slug){ focusBySlug(init.slug, true); }

    // React to navigation changes (hash/query)
    window.addEventListener('hashchange', ()=>{
      const cur=currentSlugFromURL();
      if(cur.journal){ toggleTo('journal', false); focusJournalBySlug(cur.journal, true); }
      else if(cur.slug){ toggleTo('cards', false); focusBySlug(cur.slug, true); }
    });
    window.addEventListener('popstate', ()=>{
      const cur=currentSlugFromURL();
      if(cur.journal){ toggleTo('journal', false); focusJournalBySlug(cur.journal, true); }
      else if(cur.slug){ toggleTo('cards', false); focusBySlug(cur.slug, true); }
    });
  </script>
</body>
</html>
